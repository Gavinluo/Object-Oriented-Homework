@startuml
title UC05 取消预约 活动图

|用户|
start
:打开“我的预约”页面;
:选择一条预约记录;
:点击“取消预约”;

|预约管理子系统|
:检查预约记录是否存在\n且属于当前用户;
if (记录合法?) then (是)
  ' 继续
else (否)
  :提示“预约记录无效或不属于当前用户”;
  :记录异常日志;
  stop
endif

:检查预约当前状态是否为“已预约”;
if (状态为已预约?) then (是)
  ' 继续
else (否)
  :提示“当前状态不可取消”;
  stop
endif

:计算当前时间与预约开始时间的差值;
if (满足提前取消时间要求?) then (是)
  ' 例如至少提前30分钟
else (否)
  :提示“距离开始时间过近，无法取消预约”;
  :记录取消失败原因;
  stop
endif

:更新预约状态为“已取消”;
:释放对应房间时间段占用状态;
:记录取消时间和原因;

|通知服务|
:发送“取消预约成功”通知;
if (通知发送成功?) then (是)
  :记录通知成功日志;
else (否)
  :记录通知失败日志;
  :将通知加入重试队列;
endif

|用户|
:在“我的预约”中\n查看已取消状态;
stop

@enduml
